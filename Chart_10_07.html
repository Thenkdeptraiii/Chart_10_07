<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Sensor1 Data Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.0.14/src/index.js"></script>
    //
    <link rel="stylesheet" href="https://code.highcharts.com/css/highcharts.css">
    <style>
        .highcharts-figure,
        .highcharts-data-table table {
            min-width: 320px;
            max-width: 1000px;
            margin: 1em auto;
        }

        #container {
            height: 400px;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #ebebeb;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td,
        .highcharts-data-table th,
        .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr,
        .highcharts-data-table tr:nth-child(even) {
            background: #a82c72;
        }

        .highcharts-data-table tr:hover {
            background: #829DD8;
        }

        .cell {
            height: 220px;
        }

        .highcharts-tooltip {
            font-size: 20px;
        }

        .highcharts-area {
            fill-opacity: 0.3;
        }

        #dashboard-cell-1 .highcharts-color-0 {
            fill: var(--highcharts-color-1);
            stroke: var(--highcharts-color-1);
        }

        #dashboard-cell-2 .highcharts-color-0 {
            fill: var(--highcharts-color-2);
            stroke: var(--highcharts-color-2);
        }
    </style>
</head>

<body>
    <figure class="highcharts-figure">
        <div id="container"></div>
        <p class="highcharts-description">
            Chart sẽ xuất giá trị mỗi 2 giây
        </p>
        <button id="exportButton">Xuất File Excel</button>
    </figure>

    <input type="checkbox" id="height"></input>
    <!-- ✅ BỔ SUNG VÀO TRONG <script> CỦA BẠN -->
    <script>
        const eraWidget = new EraWidget();
        let config = null;
        let config_sp = null; // <-- thêm biến cấu hình Setpoint

        let sensor1Value = 0;
        let setpoint = 0; // <-- giá trị setpoint động
        const dataBuffer = [];
        const setpointBuffer = [];

        eraWidget.onConfiguration((configuration) => {
            config = configuration.realtime_configs[0];      // sensor1
            config_sp = configuration.realtime_configs[1];   // setpoint
        });

        eraWidget.onValues((values) => {
            const input = document.getElementById('sensor1');
            sensor1Value = values[config.id].value;
            setpoint = values[config_sp.id].value;
            input.checked = sensor1Value > 0;
        });

        eraWidget.ready();

        const onChartLoad = function () {
            const chart = this;
            const series_sensor = chart.series[0];
            const series_sp = chart.series[1];

            setInterval(function () {
                const x = (new Date()).getTime();
                const y_sensor = sensor1Value;
                const y_sp = setpoint;

                // Thêm điểm mới
                series_sensor.addPoint([x, y_sensor], true, true);
                series_sp.addPoint([x, y_sp], true, true);

                // Cập nhật dữ liệu cho export
                dataBuffer.push({ time: x, sensor1: y_sensor, sp: y_sp });

                const thirtyMinutesAgo = x - 1800 * 1000;
                while (dataBuffer.length > 0 && dataBuffer[0].time < thirtyMinutesAgo) {
                    dataBuffer.shift();
                }
            }, 1000);
        };

        const timeNow = (new Date()).getTime();
        const data = [];
        for (let i = -19; i <= 0; i += 1) {
            const x = timeNow + i * 2000;
            data.push({ x: x, y: 0 }); // Giá trị mặc định ban đầu
        }

        Highcharts.chart('container', {
            chart: {
                type: 'areaspline',
                events: {
                    load: onChartLoad
                }
            },
            time: {
                useUTC: false
            },
            title: {
                text: 'Đồ Thị Đáp Ứng PID'
            },
            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150,
                maxPadding: 0.1
            },
            yAxis: {
                title: {
                    text: 'sensor1'
                },
                min: 0,
                max: 100,
                tickInterval: 10,
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                shared: true,
                headerFormat: '<b>{point.x:%Y-%m-%d %H:%M:%S}</b><br/>',
                pointFormat: '{series.name}: {point.y:.2f}<br/>'
            },
            legend: {
                enabled: true
            },
            exporting: {
                enabled: false
            },
            series: [
                {
                    name: 'Sensor1',
                    lineWidth: 2,
                    color: Highcharts.getOptions().colors[6],
                    data: data,
                    fillColor: {
                        linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                        stops: [
                            [0, Highcharts.getOptions().colors[6]],
                            [1, Highcharts.color(Highcharts.getOptions().colors[6]).setOpacity(0).get('rgba')]
                        ]
                    }
                },
                {
                    name: 'Setpoint',
                    type: 'line',
                    data: data.map(d => [d.x, 0]),
                    color: 'red',
                    dashStyle: 'Dash',
                    marker: { enabled: false },
                    enableMouseTracking: false
                }
            ]
        });

        document.getElementById('exportButton').addEventListener('click', function () {
            const ws = XLSX.utils.json_to_sheet(dataBuffer.map(point => ({
                Time: (new Date(point.time)).toLocaleString(),
                sensor1: point.sensor1,
                Setpoint: point.sp
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sensor1_Data');
            XLSX.writeFile(wb, 'sensor1_data.xlsx');
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</body>

</html>